<?php//-------------------------------------------------------------------// class GeoIPManager//-------------------------------------------------------------------class GeoIPManager{    //---------------------------------------------------------------    function check_ip($dbw, $ip, $bot)    {        global $settings;        global $READ_MARKER;                if (!defined("GETGEOAPI_API_KEYS") || empty(GETGEOAPI_API_KEYS)) {            return false;        }                if (!empty($settings["hash_ip_addresses"])) {            return false;        }        if (empty($ip)) {            return false;        }        $prfx = $dbw->escape(System::getDBPrefix());                $ip_db = $dbw->escape($ip);        if (!$dbw->execute_query("select country_code, country, city, is_tor, is_proxy, is_ipv6                                   from {$prfx}_ip_daily_statistics                                  where                                  ip = '$ip_db'                                 ")) {            MessageHandler::setError(text("ErrQueryFailed"), $dbw->get_last_error() . "\n\n" . $dbw->get_last_query());                        return false;        }                $country_code = "";         $country = "";         $city = "";         $is_tor = 0;         $is_proxy = 0;         $is_ipv6 = 0;                $exists = false;        if ($dbw->fetch_row()) {            $exists = true;                        $country_code = $dbw->field_by_name("country_code");            $country = $dbw->field_by_name("country");            $city = $dbw->field_by_name("city");            $is_tor = $dbw->field_by_name("is_tor");            $is_proxy = $dbw->field_by_name("is_proxy");            $is_ipv6 = $dbw->field_by_name("is_ipv6");        }                $dbw->free_result();                if (!$exists) {            $api_key = GETGEOAPI_API_KEYS[array_rand(GETGEOAPI_API_KEYS)];            $language = "en";            if (defined("GETGEOAPI_API_LANGUAGE") && !empty(GETGEOAPI_API_LANGUAGE)) {                $language = GETGEOAPI_API_LANGUAGE;            }                        // https://api.getgeoapi.com/v2/ip/188.244.7.49?api_key=55576c064f2b3403e94744fb85783a1c0e46f5cf&format=json&language=ru            try {                $url = "https://api.getgeoapi.com/v2/ip/" . $ip . "?api_key=" . $api_key . "&format=json&language=" . $language;                $client = new Zend_Http_Client($url, array(                    'maxredirects' => 5,                    'timeout' => 50                ));                                $request = $client->request('GET');                $response = $request->getBody();                            $json = json_decode($response, true);                if (!$json) {                    return true;                }                                if (val_or_empty($json["status"]) != "success") {                    if (!empty($json["error"]["message"])) {                        throw new Exception("GeoIP Error: " . $json["error"]["message"]);                                      }                                        return false;                }                                $country_code = val_or_empty($json["country"]["code"]);                $country = val_or_empty($json["country"]["name"]);                $city = val_or_empty($json["city"]["name"]);                $is_tor = empty($json["security"]["is_tor"]) ? 0 : 1;                $is_proxy = empty($json["security"]["is_proxy"]) ? 0 : 1;                $is_ipv6 = val_or_empty($json["type"]) == "IPv6" ? 1 : 0;            } catch (Exception $ex) {                trigger_error($ex->getMessage(), E_ERROR);                return false;            }        }        $dtnow = $dbw->format_date(mktime(0, 0, 0, date("n"), date("j"), date("Y")));        $country_code = $dbw->quotes_or_null($country_code);        $country = $dbw->quotes_or_null($country);        $city = $dbw->quotes_or_null($city);        $bot_db = $dbw->quotes_or_null($bot);        $rm = $dbw->escape($READ_MARKER);                if ($bot_db != "NULL") {            if (!$dbw->execute_query("insert into {$prfx}_ip_daily_statistics                                      (dt, ip, bot, country_code, country, city, is_tor, is_proxy, is_ipv6)                                      select                                      '$dtnow', '$ip_db', $bot_db, $country_code, $country, $city, $is_tor, $is_proxy, $is_ipv6                                      from {$prfx}_dual                                      where                                      not exists (select 1 from {$prfx}_ip_daily_statistics where ip = '$ip_db' and bot = $bot_db and dt = '$dtnow')                                     ")) {                MessageHandler::setError(text("ErrQueryFailed"), $dbw->get_last_error() . "\n\n" . $dbw->get_last_query());                                return false;            }            if (!$dbw->execute_query("update {$prfx}_ip_daily_statistics                                      set hits_count = hits_count + 1                                      where                                      ip = '$ip_db' and bot = $bot_db and dt = '$dtnow'                                     ")) {                MessageHandler::setError(text("ErrQueryFailed"), $dbw->get_last_error() . "\n\n" . $dbw->get_last_query());                                return false;            }        } else {            if (!$dbw->execute_query("insert into {$prfx}_ip_daily_statistics                                      (dt, ip, country_code, country, city, is_tor, is_proxy, is_ipv6, read_marker)                                      select                                      '$dtnow', '$ip_db', $country_code, $country, $city, $is_tor, $is_proxy, $is_ipv6, '$rm'                                      from {$prfx}_dual                                      where                                      not exists (select 1 from {$prfx}_ip_daily_statistics where ip = '$ip_db' and read_marker = '$rm' and bot is NULL and dt = '$dtnow')                                     ")) {                MessageHandler::setError(text("ErrQueryFailed"), $dbw->get_last_error() . "\n\n" . $dbw->get_last_query());                                return false;            }                        if (!$dbw->execute_query("update {$prfx}_ip_daily_statistics                                      set hits_count = hits_count + 1                                      where                                      ip = '$ip_db' and read_marker = '$rm' and bot is NULL and dt = '$dtnow'                                     ")) {                MessageHandler::setError(text("ErrQueryFailed"), $dbw->get_last_error() . "\n\n" . $dbw->get_last_query());                                return false;            }        }        return true;            } // check_ip    //---------------------------------------------------------------} // GeoIPManager//-------------------------------------------------------------------?>